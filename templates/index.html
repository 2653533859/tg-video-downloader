<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TG 视频下载器</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; background: #0f0f0f; color: #e0e0e0; min-height: 100vh; }
.header { background: #1a1a2e; padding: 16px 24px; display: flex; align-items: center; gap: 16px; border-bottom: 1px solid #333; }
.header h1 { font-size: 20px; color: #00d2ff; }
.search-box { display: flex; gap: 8px; margin-left: auto; }
.search-box input { background: #2a2a3e; border: 1px solid #444; color: #fff; padding: 8px 14px; border-radius: 6px; width: 280px; font-size: 14px; }
.search-box button, .btn { background: #0088cc; color: #fff; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; }
.btn:hover { background: #006daa; }
.btn-sm { padding: 4px 10px; font-size: 12px; }
.container { display: flex; height: calc(100vh - 60px); }
.panel { border-right: 1px solid #222; overflow-y: auto; }
.panel-dialogs { width: 280px; min-width: 200px; }
.panel-videos { flex: 1; }
.panel-downloads { width: 320px; min-width: 260px; border-right: none; }
.panel-header { padding: 12px 16px; background: #161625; border-bottom: 1px solid #222; font-size: 14px; font-weight: 600; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 8px; }
.tabs { display: flex; gap: 0; }
.tab { padding: 8px 16px; cursor: pointer; font-size: 13px; border-bottom: 2px solid transparent; color: #888; }
.tab.active { color: #00d2ff; border-bottom-color: #00d2ff; }
.dialog-item { padding: 10px 16px; border-bottom: 1px solid #1a1a1a; cursor: pointer; transition: background .15s; }
.dialog-item:hover { background: #1a1a2e; }
.dialog-item.active { background: #1a1a3e; border-left: 3px solid #00d2ff; }
.dialog-name { font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.dialog-type { font-size: 11px; color: #666; margin-top: 2px; }
.badge { display: inline-block; padding: 1px 6px; border-radius: 3px; font-size: 10px; }
.badge-channel { background: #1a3a5c; color: #4da6ff; }
.badge-group { background: #1a4a2e; color: #4dff88; }
.badge-private { background: #3a2a1a; color: #ffaa4d; }
.badge-reply { background: #3a1a3a; color: #cc88ff; font-size: 10px; margin-left: 6px; }
.video-toolbar { padding: 10px 16px; background: #161625; border-bottom: 1px solid #222; display: flex; gap: 8px; align-items: center; }
.video-toolbar label { font-size: 13px; }
.video-list { padding: 8px; }
.video-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; margin-bottom: 4px; transition: background .15s; }
.video-item:hover { background: #1a1a2e; }
.video-item input[type=checkbox] { accent-color: #00d2ff; width: 16px; height: 16px; }
.video-info { flex: 1; min-width: 0; }
.video-name { font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.video-meta { font-size: 11px; color: #666; margin-top: 3px; display: flex; gap: 12px; flex-wrap: wrap; }
.dl-item { padding: 10px 16px; border-bottom: 1px solid #1a1a1a; }
.dl-name { font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 6px; }
.dl-bar { height: 6px; background: #222; border-radius: 3px; overflow: hidden; }
.dl-bar-fill { height: 100%; background: linear-gradient(90deg, #0088cc, #00d2ff); border-radius: 3px; transition: width .3s; }
.dl-status { font-size: 11px; color: #666; margin-top: 4px; display: flex; justify-content: space-between; }
.dl-done .dl-bar-fill { background: #2ecc71; }
.dl-error .dl-bar-fill { background: #e74c3c; }
.dl-skipped .dl-bar-fill { background: #f39c12; }
.empty { text-align: center; color: #555; padding: 40px 20px; font-size: 14px; }
.loading { text-align: center; padding: 30px; color: #666; }
.file-item { padding: 8px 16px; border-bottom: 1px solid #1a1a1a; font-size: 12px; }
.file-item .folder { color: #00d2ff; }
.file-item .meta { color: #666; font-size: 11px; }
.scan-opts { display: flex; gap: 10px; align-items: center; }
.scan-opts input[type=number] { width: 60px; background: #2a2a3e; border: 1px solid #444; color: #fff; padding: 4px 8px; border-radius: 4px; font-size: 12px; text-align: center; }
.scan-opts label { font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; }
.scan-opts input[type=checkbox] { accent-color: #00d2ff; }
</style>
</head>
<body>
<div class="header">
  <h1>TG 视频下载器</h1>
  <div class="search-box">
    <input id="searchInput" placeholder="频道链接或用户名，如 @channel" onkeydown="if(event.key==='Enter')doSearch()">
    <button onclick="doSearch()">搜索</button>
  </div>
</div>
<div class="container">
  <div class="panel panel-dialogs">
    <div class="panel-header">
      对话列表
      <button class="btn btn-sm" onclick="loadDialogs()">刷新</button>
    </div>
    <div id="dialogList"><div class="loading">加载中...</div></div>
  </div>
  <div class="panel panel-videos">
    <div class="panel-header">
      <span id="videoTitle">选择一个对话以扫描视频</span>
      <div class="scan-opts">
        <label>扫描条数</label>
        <input id="scanLimit" type="number" value="100" min="10" max="5000">
        <label><input type="checkbox" id="includeReplies"> 包含评论区</label>
      </div>
    </div>
    <div class="video-toolbar" id="videoToolbar" style="display:none">
      <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
      <label for="selectAll" style="flex:1">全选 (<span id="selectedCount">0</span>/<span id="totalCount">0</span>)</label>
      <button class="btn btn-sm" onclick="downloadSelected()">下载选中</button>
    </div>
    <div id="videoList"><div class="empty">请从左侧选择对话，或搜索频道</div></div>
  </div>
  <div class="panel panel-downloads">
    <div class="tabs" style="background:#161625;border-bottom:1px solid #222">
      <div class="tab active" onclick="switchTab('downloads',this)">下载任务</div>
      <div class="tab" onclick="switchTab('files',this)">已下载文件</div>
    </div>
    <div id="tabDownloads"><div class="empty">暂无下载任务</div></div>
    <div id="tabFiles" style="display:none"><div class="loading">加载中...</div></div>
  </div>
</div>

<script>
let currentEntity = null;
let currentDialogName = '';
let videos = [];
let evtSource = null;

function loadDialogs() {
  document.getElementById('dialogList').innerHTML = '<div class="loading">加载中...</div>';
  fetch('/api/dialogs').then(r => r.json()).then(data => {
    if (data.error) { alert(data.error); return; }
    const html = data.map(d => {
      const bc = d.type === '频道' ? 'badge-channel' : d.type === '群组' ? 'badge-group' : 'badge-private';
      return `<div class="dialog-item" onclick="selectDialog(${d.index}, '${esc(d.name)}', ${d.id})">
        <div class="dialog-name">${esc(d.name)}</div>
        <div class="dialog-type"><span class="badge ${bc}">${d.type}</span> ID: ${d.id}</div>
      </div>`;
    }).join('');
    document.getElementById('dialogList').innerHTML = html || '<div class="empty">无对话</div>';
  }).catch(e => {
    document.getElementById('dialogList').innerHTML = `<div class="empty">加载失败: ${e}</div>`;
  });
}

function selectDialog(index, name, id) {
  document.querySelectorAll('.dialog-item').forEach((el, i) => el.classList.toggle('active', i === index));
  currentEntity = { dialog_index: index, entity_id: id, source: 'dialog' };
  currentDialogName = name;
  scanVideos();
}

function doSearch() {
  const q = document.getElementById('searchInput').value.trim();
  if (!q) return;
  document.getElementById('videoList').innerHTML = '<div class="loading">搜索中...</div>';
  fetch('/api/search?q=' + encodeURIComponent(q)).then(r => r.json()).then(data => {
    if (data.error) { alert(data.error); return; }
    currentEntity = { entity_id: data.id, source: 'search' };
    currentDialogName = data.name;
    scanVideos();
  }).catch(e => alert('搜索失败: ' + e));
}

function scanVideos() {
  const limit = document.getElementById('scanLimit').value || 100;
  const includeReplies = document.getElementById('includeReplies').checked;
  document.getElementById('videoTitle').textContent = currentDialogName + ' - 扫描中...';
  document.getElementById('videoList').innerHTML = '<div class="loading">正在扫描视频...' + (includeReplies ? '(含评论区，可能较慢)' : '') + '</div>';
  document.getElementById('videoToolbar').style.display = 'none';
  const params = new URLSearchParams({ ...currentEntity, limit, include_replies: includeReplies });
  fetch('/api/videos?' + params).then(r => r.json()).then(data => {
    if (data.error) { alert(data.error); return; }
    videos = data;
    document.getElementById('videoTitle').textContent = `${currentDialogName} (${videos.length} 个视频)`;
    if (!videos.length) {
      document.getElementById('videoList').innerHTML = '<div class="empty">未找到视频</div>';
      return;
    }
    document.getElementById('videoToolbar').style.display = 'flex';
    document.getElementById('totalCount').textContent = videos.length;
    document.getElementById('selectAll').checked = false;
    updateSelectedCount();
    const html = videos.map((v, i) => `
      <div class="video-item">
        <input type="checkbox" class="vcb" data-idx="${i}" onchange="updateSelectedCount()">
        <div class="video-info">
          <div class="video-name" title="${esc(v.filename)}">${esc(v.filename)}${v.source && v.source !== '主消息' ? '<span class="badge badge-reply">' + esc(v.source) + '</span>' : ''}</div>
          <div class="video-meta">
            <span>${v.size_fmt}</span>
            <span>${v.duration_fmt}</span>
            <span>${v.date}</span>
          </div>
        </div>
      </div>
    `).join('');
    document.getElementById('videoList').innerHTML = html;
  }).catch(e => {
    document.getElementById('videoList').innerHTML = `<div class="empty">扫描失败: ${e}</div>`;
  });
}

function toggleSelectAll() {
  const checked = document.getElementById('selectAll').checked;
  document.querySelectorAll('.vcb').forEach(cb => cb.checked = checked);
  updateSelectedCount();
}

function updateSelectedCount() {
  document.getElementById('selectedCount').textContent = document.querySelectorAll('.vcb:checked').length;
}

function downloadSelected() {
  const indices = [...document.querySelectorAll('.vcb:checked')].map(cb => +cb.dataset.idx);
  if (!indices.length) { alert('请先选择视频'); return; }
  const msgIds = indices.map(i => videos[i].id);
  const container = document.getElementById('tabDownloads');
  indices.forEach(i => {
    const v = videos[i];
    addDownloadItem(v.id, v.filename, v.size_fmt);
  });
  switchTab('downloads', document.querySelector('.tab'));
  fetch('/api/download', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ message_ids: msgIds, dialog_name: currentDialogName }),
  }).then(r => r.json()).then(data => {
    if (data.error) { alert(data.error); return; }
    startProgressPolling();
  });
}

function addDownloadItem(msgId, filename, size) {
  const container = document.getElementById('tabDownloads');
  if (container.querySelector('.empty')) container.innerHTML = '';
  if (document.getElementById('dl-' + msgId)) return;
  container.insertAdjacentHTML('afterbegin', `
    <div class="dl-item" id="dl-${msgId}">
      <div class="dl-name" title="${esc(filename)}">${esc(filename)}</div>
      <div class="dl-bar"><div class="dl-bar-fill" style="width:0%"></div></div>
      <div class="dl-status"><span class="dl-pct">等待中</span><span class="dl-size">${size}</span></div>
    </div>
  `);
}

function startProgressPolling() {
  if (evtSource) { evtSource.close(); evtSource = null; }
  evtSource = new EventSource('/api/progress');
  evtSource.onmessage = function(e) {
    const data = JSON.parse(e.data);
    for (const [msgId, info] of Object.entries(data)) {
      if (msgId === '_complete') {
        evtSource.close();
        evtSource = null;
        loadFiles();
        return;
      }
      const el = document.getElementById('dl-' + msgId);
      if (!el) continue;
      el.querySelector('.dl-bar-fill').style.width = info.progress + '%';
      if (info.status === 'done') {
        el.querySelector('.dl-pct').textContent = '完成';
        el.classList.add('dl-done');
      } else if (info.status === 'skipped') {
        el.querySelector('.dl-pct').textContent = '已跳过(文件存在)';
        el.classList.add('dl-skipped');
      } else if (info.status === 'error') {
        el.querySelector('.dl-pct').textContent = '错误: ' + info.error;
        el.classList.add('dl-error');
      } else if (info.status === 'downloading') {
        el.querySelector('.dl-pct').textContent = info.progress + '%';
        if (info.downloaded) el.querySelector('.dl-size').textContent = info.downloaded + ' / ' + info.total;
      } else {
        el.querySelector('.dl-pct').textContent = '等待中';
      }
    }
  };
  evtSource.onerror = function() { evtSource.close(); evtSource = null; };
}

function switchTab(tab, el) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  el.classList.add('active');
  document.getElementById('tabDownloads').style.display = tab === 'downloads' ? '' : 'none';
  document.getElementById('tabFiles').style.display = tab === 'files' ? '' : 'none';
  if (tab === 'files') loadFiles();
}

function loadFiles() {
  fetch('/api/files').then(r => r.json()).then(data => {
    if (!data.length) {
      document.getElementById('tabFiles').innerHTML = '<div class="empty">暂无已下载文件</div>';
      return;
    }
    const html = data.map(f => `
      <div class="file-item">
        <div><span class="folder">${esc(f.folder)}/</span> ${esc(f.filename)}</div>
        <div class="meta">${f.size} · ${f.modified}</div>
      </div>
    `).join('');
    document.getElementById('tabFiles').innerHTML = html;
  });
}

function esc(s) {
  const d = document.createElement('div');
  d.textContent = s;
  return d.innerHTML;
}

loadDialogs();
</script>
</body>
</html>

